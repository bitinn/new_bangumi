"use strict";$(function(){$("noscript").remove();var ac=0,aa=0,Z=0;var Y=0,W=0,V=0;var H=0,O=0,s=0,c=0;var X=0,h=0;var K=null;var M=["周日","周一","周二","周三","周四","周五","周六"];var y=["日曜","月曜","火曜","水曜","木曜","金曜","土曜"];var f={list:[{name:"A站",domain:"acfun",show:true},{name:"B站",domain:"bilibili",show:true},{name:"搜狐",domain:"sohu",show:true},{name:"优酷",domain:"youku",show:true},{name:"腾讯",domain:"qq",show:true},{name:"爱奇艺",domain:"iqiyi",show:true},{name:"乐视",domain:"letv",show:true},{name:"PPTV",domain:"pptv",show:true},{name:"土豆",domain:"tudou",show:true},{name:"迅雷",domain:"movie",show:true}],turnAll:function(j){var i=[];for(Z=0,V=this.list.length;Z<V;Z++){if(this.list[Z].show!==j){this.list[Z].show=j;i.push(this.list[Z].domain)}}return i},show:function(j,i){for(Z=0,V=this.list.length;Z<V;Z++){if(this.list[Z].name===j||this.list[Z].domain===j){if(i!==undefined){this.list[Z].show=i}return this.list[Z].show}}return undefined}};var x=$("#bangumiList");var R=$("#shadow");var I=$("#switcher");var U=$("table th:eq(1) p");var o=$("table th:eq(2) p");var e=$("#search input");var N=$("#topnav");var G=$("#hourSelecter");var ae=null,A=null;var L={reverse:true,ordered:"CN",switchInit:7,switchLog:7,weekDay:-1,nextTime:24,title:"",lastModified:"",showAll:false,history:false,newTab:false,jpTime:false,jpTimeZone:8,jpTitle:false,showNew:false};function D(i){switch(i){case"true":return true;case"false":return false;default:return !!i}}function af(i,j){switch(j.toLowerCase()){case"cn":return M[i];case"jp":return y[i];default:return M[i]}}function Q(i){if(i===-1){return"(未知)"}else{return i?i.slice(0,2)+":"+i.slice(2):"(预计)"}}function S(i){switch(true){case (i<4):return 1;case (i<7):return 4;case (i<10):return 7;case (i<=12):return 10;default:throw new Error("failed convrting to season")}}function u(){var j=0;var i=N.find(".sites :checkbox");for(ac=0,Y=i.length;ac<Y;ac++){if(f.show(i.get(ac).id)){i.eq(ac).attr("checked",true).prev().find("span").addClass("ON");j++}else{i.eq(ac).attr("checked",false).prev().find("span").removeClass("ON")}}if(j===i.length){$("#selectAll").text("全不选")}else{$("#selectAll").text("全选")}}function ab(i){var j=/^https{0,}:\/\/\w+\.(\w+)\.\w+/i;if(i!=="#"){return i.match(j)[1].toLowerCase()}else{return""}}function w(k,l,j){X=k;h=S(l);for(ac=0,Y=j.length;ac<Y;ac++){if(j[ac].year===k){var i=j[ac].months;for(aa=0,W=i.length;aa<W;aa++){if(h===i[aa].month&&i[aa].json){return i[aa].json}}if(h===1){return w(k-1,10,j)}else{return w(k,l-3,j)}}}return w(k-1,l,j)}function C(j,i){j=b(ab(j));i=b(ab(i));if(j.length===i.length){if(j<i){return -1}else{if(j>i){return 1}else{return 0}}}else{return j.length-i.length}}function b(i){switch(i){case"youku":return"优酷";case"sohu":return"搜狐";case"qq":return"腾讯";case"iqiyi":return"爱奇艺";case"letv":return"乐视";case"pptv":return"PPTV";case"tudou":return"土豆";case"bilibili":return"B站";case"acfun":return"A站";case"movie":return"迅雷";default:return"未知"}}function d(i){x.empty();x.append(i);x.find(".links li:last-child").addClass("last");t()}function T(i){return function(k,j,l){$(this).parents("tr").find("p").removeClass("ordered");$(this).addClass("ordered");if(j!==undefined){r(A,j,i)}else{r(A,!L.reverse,i)}d(v(A));if(!l){B()}}}function g(){var j="";var i=null;for(ac=0,Y=f.list.length;ac<Y;ac++){j+='<li><label for="'+f.list[ac].domain+'">'+f.list[ac].name+'<span class="toggle"></span></label><input type="checkbox" name="'+f.list[ac].domain+'" id="'+f.list[ac].domain+'"></li>'}i=$(j);i.find(":checkbox").change(function(){f.show(this.id,this.checked);u();d(v(A));L.ordered="CN";I.trigger("click",[L.switchLog,true]);$.cookie(this.id,this.checked,{expires:365})});N.find(".sites").prepend(i)}function r(m,k,ag){var j="",n="";var i=(k?-1:1);var l=0,ah=0;L.reverse=k;L.ordered=ag;if(ag){j="weekDay"+ag.toUpperCase();n="time"+ag.toUpperCase()}else{j="weekDayCN";n="timeCN"}m.sort(function(aj,ai){if(aj[j]===ai[j]){l=(aj[n]===""?-1:+aj[n]);ah=(ai[n]===""?-1:+ai[n]);if(l===ah){return i*(aj.officalSite-ai.officalSite)}else{return i*(l-ah)}}else{return i*(aj[j]-ai[j])}})}function v(j){var i="",k="";for(ac=0,Y=j.length;ac<Y;ac++){i+='<tr><td><a href="'+j[ac].officalSite+'" title="'+(L.jpTitle?j[ac].titleCN:j[ac].titleJP)+(j[ac].newBgm?'" class="new">':'">')+(L.jpTitle?j[ac].titleJP:j[ac].titleCN)+"</a></td><td>"+(j[ac].comment?'<div class="comment"><div class="tooltip">'+j[ac].comment+"</div></div>":"")+'</td><td><span class="weekDay">'+af(j[ac].weekDayJP,(L.jpTime?"jp":"cn"))+'</span><span class="time">'+Q(j[ac].timeJP)+'</span></td><td><span class="weekDay">'+af(j[ac].weekDayCN,"cn")+'</span><span class="time">'+Q(j[ac].timeCN)+"</span></td>";if(j[ac].onAirSite.length){k="";j[ac].onAirSite.sort(C);i+='<td><ul class="links">';for(aa=0,W=j[ac].onAirSite.length;aa<W;aa++){if(f.show(ab(j[ac].onAirSite[aa]))){if(aa===W-1){k+="<li>"}else{k+="<li>"}k+='<a href="'+j[ac].onAirSite[aa]+'" target="_self">'+b(ab(j[ac].onAirSite[aa]))+"</a></li>"}}if(k===""){k+='<li class="empty">过滤</li>'}i+=k+"</ul></td></tr>"}else{i+='<td><ul class="links"><li class="empty">暂无</li></ul></td></tr>'}}return i}function F(l){var k="";var j=null;for(ac=0,Y=l.length;ac<Y;ac++){var i=l[ac].months;k+='<li><a href="#">'+l[ac].year+'年</a><ul class="submenu month">';for(aa=0,W=i.length;aa<W;aa++){k+='<li><a href="#" data-json="'+i[aa].json+'">'+i[aa].month+"月</a></li>"}k+="</ul></li>"}j=$(k);j.each(function(){$(this).hover(function(){$(this).find("ul").show()},function(){$(this).find("ul").hide()}).find("ul").hide()});j.find("ul a").click(function(){var m=$(this).data("json");L.history=true;q(m);X=+("20"+m.match(/(\d{2})(\d{2})/)[1]);h=+(m.match(/(\d{2})(\d{2})/)[2]);$(this).parents(".submenu").hide();return false});N.find("li ul.year").append(j)}function B(){var j=x.find("tr");var i=0;j.detach();for(ac=0,Y=j.length;ac<Y;ac++){if(L.showNew&&j.eq(ac).find(".new").length){j.eq(ac).find(".new").addClass("hideMark")}else{j.eq(ac).find(".new").removeClass("hideMark")}if(z(j.eq(ac))){j.eq(ac).show();i++}else{j.eq(ac).hide()}}j.appendTo(x);if(i===0){$('<tr><td colspan="5">无结果</td></tr>').appendTo(x)}}function t(){x.find(".comment").click(function(){var i=$(this).find("div");if($(this).position().top<=i.innerHeight()*2){i.addClass("opposite")}i.toggle()}).hover(function(){var i=$(this).find("div");if($(this).position().top<=i.innerHeight()*2){i.addClass("opposite").show()}else{i.show()}},function(){$(this).find("div").hide()})}function J(i){if(i){x.find("a").attr("target",i)}else{x.find("a").attr("target","_self")}}function a(){G.find("span").removeClass("disable");if(L.nextTime===24){G.find(".right").addClass("disable")}else{if(L.nextTime===20){G.find(".left").addClass("disable")}}G.find("p").text(L.nextTime+"点")}function z(m){var l=false;var k=m.find("td:eq(3) .weekDay").text();var i=+(m.find("td:eq(3) .time").text().slice(0,2));if(!i){i=0}if(L.weekDay===-1){l=true}else{if((k===M[L.weekDay]&&i<L.nextTime)||(k===M[(L.weekDay===0?6:L.weekDay-1)]&&i>=L.nextTime)){l=true}}if(L.showNew&&!(m.find("td:eq(0) a").is(".new"))){l=false}if(L.title){var j=new RegExp("\\"+L.title,"i");var n=m.find("td:eq(0) a");if(!j.test(n.text())&&!j.test(n.attr("title"))){l=false}}return l}function p(j){var k=I.find("li:eq("+j+")");var i=k.text();k.text("今天");k.hover(function(){$(this).text(i)},function(){$(this).text("今天")})}function P(){if($.cookie("showNew")!==undefined){L.showNew=$.cookie("showNew",D)}if(L.showNew){N.find("#showNew").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("showAll")!==undefined){L.showAll=$.cookie("showAll",D)}if(L.showAll){N.find("#showAll").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("newTab")!==undefined){L.newTab=$.cookie("newTab",D)}if(L.newTab){N.find("#newTab").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("jpTime")!==undefined){L.jpTime=$.cookie("jpTime",D)}if(L.jpTime){N.find("#jpTime").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("jpTitle")!==undefined){L.jpTitle=$.cookie("jpTitle",D)}if(L.jpTitle){N.find("#jpTitle").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("nextTime")!==undefined){L.nextTime=$.cookie("nextTime",Number)}a();for(ac=0,Y=f.list.length;ac<Y;ac++){if($.cookie(f.list[ac].domain)!==undefined){f.list[ac].show=$.cookie(f.list[ac].domain,D)}}}function ad(){var i=document.cookie.match(/[^ =;]+(?=\=)/g);if(i){for(ac=0,Y=i.length;ac<Y;ac++){$.removeCookie(i[ac])}}location.reload(true)}function E(n,j){var m=j-L[n.toLowerCase()+"TimeZone"];var l="time"+n.toUpperCase();var ag="weekDay"+n.toUpperCase();var k,i;for(ac=0,Y=A.length;ac<Y;ac++){k=+A[ac][l].slice(0,2);i=+A[ac][ag];k=k+m;if(k<0){k+=24;i--}else{if(k>=24){k-=24;i++}}if(k<10){k="0"+k}if(i<0){i+=7}else{if(i>6){i-=7}}A[ac][l]=k+A[ac][l].slice(2);A[ac][ag]=i+""}L[n.toLowerCase()+"TimeZone"]=j}function q(i){$.ajax({url:i,success:function(l,k,m){A=l;P();if(L.history){L.jpTimeZone=8}if(L.jpTime){E("jp",9)}if(L.history||L.showAll){I.trigger("click",[7,true,true])}else{I.trigger("click",[L.switchInit,true,true])}B();if(L.newTab){J("_blank")}g();u();if(m.getResponseHeader("Last-Modified")){var j=new Date(m.getResponseHeader("Last-Modified"));L.lastModified="数据更新日期: "+j.getFullYear()+"年"+(j.getMonth()+1)+"月"+j.getDate()+"日"}$("#header h1").text(X+"年"+h+"月番组");$("#header .total").text("当季共有"+l.length+"部番组");$("#header .lastModified").text(L.lastModified);R.hide()},error:function(l,k,j){x.append('<tr><td colspan="4">读取 '+i+" 出错，错误代码："+l.status+" "+j+"</td></tr>")}})}$.ajax({url:"json/archive.json",success:function(j,i,k){H=(k.getResponseHeader("Date")?new Date(k.getResponseHeader("Date")):new Date());s=H.getFullYear();c=H.getMonth()+1;O=H.getDay();L.switchInit=(O===0?6:O-1);p(L.switchInit);ae=j;q(w(s,c,j));F(j)},error:function(k,j,i){x.append('<tr><td colspan="4">读取 json/archive.json 出错，错误代码：'+k.status+" "+i+"</td></tr>")}});I.click(function(l,k,m,j){var i=$(l.target);if(l.target!==this||m){I.find("li").removeClass("selected");if(k!==undefined){I.find("li:eq("+k+")").addClass("selected")}else{k=i.index();i.addClass("selected")}L.switchLog=k;if(k===6){L.weekDay=0}else{if(k===7){L.weekDay=-1}else{L.weekDay=k+1}}if(k===7&&(L.ordered!=="JP"||L.reverse!==false)){U.trigger("click",[false,true])}else{if(L.ordered!=="CN"||L.reverse!==false){o.trigger("click",[false,true])}}if(!j){B()}}});o.click(T("CN"));U.click(T("JP"));N.find(".menu").hover(function(){window.clearTimeout(K);N.find("ul").hide();$(this).children("ul").show();R.show()},function(){if(Function.prototype.bind){window.clearTimeout(K);K=window.setTimeout(function(){$(this).children("ul").hide();R.hide()}.bind(this),300)}else{$(this).children("ul").hide();R.hide()}}).children("a").click(function(i){if(i.target===this){$(this).next().toggle();R.toggle()}return false}).find("ul").hide();e.keyup(function(i){I.trigger("click",[7,true,true]);$(this).next().show();L.title=$(this).val();B();if(i.keyCode===27){$(this).blur().val("");L.title="";if(L.showAll||L.history){I.trigger("click",[7,true])}else{I.trigger("click",[L.switchInit,true])}$(this).next().hide()}else{if(i.keyCode===8&&i.target.value.length<=0){if(L.showAll||L.history){I.trigger("click",[7,true])}else{I.trigger("click",[L.switchInit,true])}$(this).next().hide()}}}).next().hide().click(function(){e.blur().val("");L.title="";I.trigger("click",[L.switchInit,true]);$(this).hide()});$("#showNew").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}L.showNew=this.checked;$.cookie("showNew",this.checked,{expires:365});B()});$("#showAll").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}L.showAll=this.checked;if(this.checked){I.trigger("click",[7,true])}else{I.trigger("click",[L.switchInit,true])}$.cookie("showAll",this.checked,{expires:365});B()});$("#newTab").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}L.newTab=this.checked;$.cookie("newTab",this.checked,{expires:365});J((L.newTab?"_blank":"_self"))});$("#jpTime").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}L.jpTime=this.checked;$.cookie("jpTime",this.checked,{expires:365});if(L.jpTime){E("jp",9)}else{E("jp",8)}d(v(A));B()});$("#jpTitle").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}L.jpTitle=this.checked;$.cookie("jpTitle",this.checked,{expires:365});d(v(A));B()});G.find("span").click(function(i){if(i.target.className==="right"&&L.nextTime<24){L.nextTime++;B()}else{if(i.target.className==="left"&&L.nextTime>20){L.nextTime--;B()}}a();$.cookie("nextTime",L.nextTime,{expires:365})});$("#reset").click(ad);$("#selectAll").click(function(){var i=null;if($(this).text()==="全选"){i=f.turnAll(true)}else{if($(this).text()==="全不选"){i=f.turnAll(false)}}d(v(A));I.trigger("click",[L.switchLog,true]);u();for(ac=0,Y=i.length;ac<Y;ac++){$.cookie(i[ac],f.show(i[ac]),{expires:365})}});R.click(function(i){$(this).hide();N.find("ul").hide()});N.find(".share a").click(function(){window.open(this.href,"","height=420, width=550, scrollbars=yes");return false})});