"use strict";function getDomain(a){var b=/^https{0,}:\/\/\w+\.(\w+)\.\w+/i;if(a!=="#"){return a.match(b)[1].toLowerCase()}else{return"empty"}}angular.module("BangumiList",["ieFix","ipCookie"]).controller("ListController",["$scope","$http","ipCookie",function(j,h,a){var g,e,f,b;var d=0,c=0;j.switcherList=[{name:"周一",index:1,order:"cn"},{name:"周二",index:2,order:"cn"},{name:"周三",index:3,order:"cn"},{name:"周四",index:4,order:"cn"},{name:"周五",index:5,order:"cn"},{name:"周六",index:6,order:"cn"},{name:"周日",index:0,order:"cn"},{name:"全部",index:-1,order:"jp"}];j.siteList=[{name:"A站",domain:"acfun"},{name:"B站",domain:"bilibili"},{name:"搜狐",domain:"sohu"},{name:"优酷",domain:"youku"},{name:"腾讯",domain:"qq"},{name:"爱奇艺",domain:"iqiyi"},{name:"乐视",domain:"letv"},{name:"PPTV",domain:"pptv"},{name:"土豆",domain:"tudou"},{name:"迅雷",domain:"movie"}];j.query={nextTime:24,weekDayCN:-1,titleCN:"",showNew:false};j.setting={nextTimeMax:24,nextTimeMin:20,linkTarget:"_self",showAll:false,newTab:false};j.status={nextTime:"",error:false,errorMsg:"",reversed:true,ordered:"cn","status.lastModifieded":"",selectAll:true,shadow:false,showAll:false,menu:{archive:false,display:false,sites:false}};j.changeTarget=function(){if(j.setting.newTab){j.status.linkTarget="_blank"}else{j.status.linkTarget="_self"}a("newTab",j.setting.newTab,{expires:365})};j.clearCookie=function(){var i=document.cookie.match(/[^ =;]+(?=\=)/g);if(i){for(d=0,c=i.length;d<c;d++){a.remove(i[d])}j.query.nextTime=24;j.checkNextTime();j.query.showNew=false;j.setting.showAll=false;for(d=0,c=j.siteList.length;d<c;d++){j.siteList[d].show=true}j.checkSiteList();j.setting.newTab=false;j.changeTarget()}};j.linkHandler=function(i,k){if(i==="#"){if(k.preventDefault){k.preventDefault()}else{k.returnValue=false}}};j.resumeSearch=function(){j.query.titleCN="";if(!j.setting.showAll&&!j.status.showAll){j.query.weekDayCN=e}};j.searchHandler=function(i){if(j.query.weekDayCN!==-1){j.query.weekDayCN=-1}if(i.keyCode===27||(i.keyCode===8&&i.target.value.length<=1)){j.resumeSearch()}};j.switcherHandler=function(k,i){j.query.titleCN="";j.query.weekDayCN=k;j.order(j.bangumis,i,false);if(k===-1){j.status.showAll=true}else{j.status.showAll=false}};j.bgmFilter=function(l){var i=false;if(j.query.weekDayCN===-1){i=true}else{if((l.weekDayCN===j.query.weekDayCN&&+l.timeCN.slice(0,2)<j.query.nextTime)||((l.weekDayCN===6?0:l.weekDayCN+1)===j.query.weekDayCN&&+l.timeCN.slice(0,2)>=j.query.nextTime)){i=true}}if(j.query.showNew&&l.newBgm===false){i=false}if(j.query.titleCN){var k=new RegExp(j.query.titleCN,"i");if(!k.test(l.titleCN)){i=false}}return i};j.hourSelectHandler=function(i){if(i==="+"){if(j.query.nextTime>=j.setting.nextTimeMax){j.query.nextTime=j.setting.nextTimeMax}else{j.query.nextTime=j.query.nextTime+1}j.checkNextTime()}else{if(i==="-"){if(j.query.nextTime<=j.setting.nextTimeMin){j.query.nextTime=j.setting.nextTimeMin}else{j.query.nextTime=j.query.nextTime-1}j.checkNextTime()}}a("nextTime",j.query.nextTime,{expires:365})};j.checkNextTime=function(){if(j.query.nextTime===j.setting.nextTimeMax){j.status.nextTime="max"}else{if(j.query.nextTime===j.setting.nextTimeMin){j.status.nextTime="min"}else{j.status.nextTime=""}}};j.getSiteCookie=function(){return j.siteList.map(function(i){var k=a(i.domain);if(k!==undefined){i.show=k}else{i.show=true}return i})};j.siteHandler=function(k,i){a(k,i,{expires:365});j.checkSiteList()};j.newOnlyHandler=function(){a("showNew",j.query.showNew,{expires:365})};j.showAllHandler=function(){j.status.showAll=j.setting.showAll;if(j.setting.showAll){j.query.weekDayCN=-1;j.order(j.bangumis,"jp",false)}else{j.query.weekDayCN=e;j.order(j.bangumis,"cn",false)}a("showAll",j.setting.showAll,{expires:365})};j.archiveHandler=function(i,k){j.readBgm(j.getJsonPath(i,k,j.archive),"jp",false);j.query.weekDayCN=-1;j.setting.showAll=true};j.status.shadowHandler=function(){j.status.menu.archive=false;j.status.menu.display=false;j.status.menu.sites=false;j.status.shadow=false};j.topMenuHandler=function(k,i,m){for(var l in j.status.menu){l=false}j.status.menu[k]=i;if(m!==undefined){j.status.shadow=m}else{j.status.shadow=i}};j.checkSiteList=function(){j.status.selectAll=false;for(d=0,c=j.siteList.length;d<c;d++){if(j.siteList[d].show===false){j.status.selectAll=true;break}}};j.selectAllHandler=function(i){for(d=0,c=j.siteList.length;d<c;d++){j.siteList[d].show=i;a(j.siteList[d].domain,j.siteList[d].show,{expires:365})}j.status.selectAll=!j.status.selectAll};j.order=function(k,n,i){var l="weekDay"+n.toUpperCase(),m="time"+n.toUpperCase();j.status.reversed=!i;j.status.ordered=n;i=i?-1:1;return k.sort(function(p,o){if(p[l]===o[l]){if(p[m]===""){return i*-1}else{if(o[m]===""){return i*1}else{return i*(p[m]-o[m])}}}else{return i*(p[l]-o[l])}})};j.monthToSeason=function(i){switch(true){case (i<4):return 1;case (i<7):return 4;case (i<10):return 7;case (i<=12):return 10;default:throw new Error("failed convrting to season")}};j.getJsonPath=function(m,n,l){for(var k in l){if(l[k].year==m){var i=l[k].months;j.yearRead=l[k].year;j.monthRead=j.monthToSeason(n);for(d=0,c=i.length;d<c;d++){if(j.monthRead===i[d].month&&i[d].json){return i[d].json}}if(j.monthRead===1){return j.getJsonPath(m-1,10,l)}else{return j.getJsonPath(m,n-3,l)}}}return j.getJsonPath(m-1,n,l)};j.readBgm=function(l,i,k){h.get(l).success(function(o,m,p){j.bangumis=j.order(o,i,k);j.query.titleCN="";if(p("Last-Modified")){var n=new Date(p("Last-Modified"));j.status.lastModifieded="数据更新日期: "+n.getFullYear()+"年"+(n.getMonth()+1)+"月"+n.getDate()+"日"}}).error(function(n,m){j.status.error=true;j.status.errorMsg="读取 "+l+" 出错. 错误代码: "+m+". 请点击上方的“提交问题”按钮."})};h.get("json/archive.json").success(function(l,i,m){g=m("Date")?new Date(m("Date")):new Date();e=g.getDay();f=g.getFullYear();b=g.getMonth()+1;j.query.weekDayCN=e;for(var k in l){l[k].show=l[k].year==f?true:false}j.archive=l;j.setting.showAll=a("showAll")||false;if(j.setting.showAll){j.readBgm(j.getJsonPath(f,b,l),"jp",false);j.query.weekDayCN=-1}else{j.readBgm(j.getJsonPath(f,b,l),j.status.ordered,!j.status.reversed)}j.siteList=j.getSiteCookie();j.checkSiteList();j.query.showNew=a("showNew")||false;j.query.nextTime=a("nextTime")||24;j.checkNextTime();j.setting.newTab=a("newTab")||false;j.changeTarget()}).error(function(k,i){j.status.error=true;j.status.errorMsg="读取 archive.json 出错. 错误代码: "+i+". 请点击上方的“提交问题”按钮."})}]).filter("selectAllButton",function(){return function(a){return a?"全选":"全不选"}}).filter("weekday",function(){var a=["周日","周一","周二","周三","周四","周五","周六"];return function(b){return a[b]}}).filter("time",function(){return function(a){return a?a.slice(0,2)+":"+a.slice(2):"(预计)"}}).filter("monthCN",function(){return function(a){switch(+a){case 1:return"一月";case 4:return"四月";case 7:return"七月";case 10:return"十月";default:throw new Error("failed to convert month")}}}).filter("onair",function(){return function(a){switch(getDomain(a)){case"youku":return"优酷";case"sohu":return"搜狐";case"qq":return"腾讯";case"iqiyi":return"爱奇艺";case"letv":return"乐视";case"pptv":return"PPTV";case"tudou":return"土豆";case"bilibili":return"B站";case"acfun":return"A站";case"movie":return"迅雷";case"empty":return"暂无";default:return"未知"}}}).filter("linkFilter",function(){return function(c,a){var b=[];b=c.filter(function(f){for(var e=0,d=a.length;e<d;e++){if(a[e].domain===getDomain(f)){return a[e].show}}return false});if(b.length!==0){return b.sort(function(e,d){e=getDomain(e);d=getDomain(d);if(e<d){return -1}else{if(e>d){return 1}else{return 0}}})}else{return["#"]}}});