"use strict";function getDomain(a){var b=/^https{0,}:\/\/\w+\.(\w+)\.\w+/i;if(a!=="#"){return a.match(b)[1].toLowerCase()}else{return"empty"}}angular.module("BangumiList",["ieFix","ipCookie"]).controller("ListController",["$scope","$http","ipCookie","$window",function(k,j,b,a){var h,f,g,c;var e=0,d=0;k.switcherList=[{name:"周一",index:1,order:"cn"},{name:"周二",index:2,order:"cn"},{name:"周三",index:3,order:"cn"},{name:"周四",index:4,order:"cn"},{name:"周五",index:5,order:"cn"},{name:"周六",index:6,order:"cn"},{name:"周日",index:0,order:"cn"},{name:"全部",index:-1,order:"jp"}];k.siteList=[{name:"A站",domain:"acfun"},{name:"B站",domain:"bilibili"},{name:"搜狐",domain:"sohu"},{name:"优酷",domain:"youku"},{name:"腾讯",domain:"qq"},{name:"爱奇艺",domain:"iqiyi"},{name:"乐视",domain:"letv"},{name:"PPTV",domain:"pptv"},{name:"土豆",domain:"tudou"},{name:"迅雷",domain:"movie"}];k.query={nextTime:24,weekDayCN:-1,titleCN:"",showNew:false};k.setting={nextTimeMax:24,nextTimeMin:20,linkTarget:"_self",showAll:false,newTab:false};k.status={nextTime:"",error:false,errorMsg:"",reversed:true,ordered:"cn","status.lastModifieded":"",selectAll:true,shadow:false,showAll:false,history:false,menu:{archive:false,display:false,sites:false},subMenu:{}};k.changeTarget=function(){if(k.setting.newTab){k.status.linkTarget="_blank"}else{k.status.linkTarget="_self"}b("newTab",k.setting.newTab,{expires:365})};k.clearCookie=function(){var i=document.cookie.match(/[^ =;]+(?=\=)/g);if(i){for(e=0,d=i.length;e<d;e++){b.remove(i[e])}k.query.nextTime=24;k.checkNextTime();k.query.showNew=false;k.setting.showAll=false;for(e=0,d=k.siteList.length;e<d;e++){k.siteList[e].show=true}k.checkSiteList();k.setting.newTab=false;k.changeTarget()}};k.linkHandler=function(i,l){if(i==="#"){if(l.preventDefault){l.preventDefault()}else{l.returnValue=false}}};k.resumeSearch=function(){k.query.titleCN="";if(!k.setting.showAll&&!k.status.showAll){k.query.weekDayCN=f}};k.searchHandler=function(i){if(k.query.weekDayCN!==-1){k.query.weekDayCN=-1}if(i.keyCode===27||(i.keyCode===8&&i.target.value.length<=1)){k.resumeSearch()}};k.switcherHandler=function(l,i){k.query.titleCN="";k.query.weekDayCN=l;k.order(k.bangumis,i,false);if(l===-1){k.status.showAll=true}else{k.status.showAll=false}};k.bgmFilter=function(m){var i=false;if(k.query.weekDayCN===-1){i=true}else{if((m.weekDayCN===k.query.weekDayCN&&+m.timeCN.slice(0,2)<k.query.nextTime)||((m.weekDayCN===6?0:m.weekDayCN+1)===k.query.weekDayCN&&+m.timeCN.slice(0,2)>=k.query.nextTime)){i=true}}if(k.query.showNew&&m.newBgm===false){i=false}if(k.query.titleCN){var l=new RegExp(k.query.titleCN,"i");if(!l.test(m.titleCN)){i=false}}return i};k.hourSelectHandler=function(i){if(i==="+"){if(k.query.nextTime>=k.setting.nextTimeMax){k.query.nextTime=k.setting.nextTimeMax}else{k.query.nextTime=k.query.nextTime+1}k.checkNextTime()}else{if(i==="-"){if(k.query.nextTime<=k.setting.nextTimeMin){k.query.nextTime=k.setting.nextTimeMin}else{k.query.nextTime=k.query.nextTime-1}k.checkNextTime()}}b("nextTime",k.query.nextTime,{expires:365})};k.checkNextTime=function(){if(k.query.nextTime===k.setting.nextTimeMax){k.status.nextTime="max"}else{if(k.query.nextTime===k.setting.nextTimeMin){k.status.nextTime="min"}else{k.status.nextTime=""}}};k.getSiteCookie=function(){return k.siteList.map(function(i){var l=b(i.domain);if(l!==undefined){i.show=l}else{i.show=true}return i})};k.siteHandler=function(l,i){b(l,i,{expires:365});k.checkSiteList()};k.newOnlyHandler=function(){b("showNew",k.query.showNew,{expires:365})};k.showAllHandler=function(){k.status.showAll=k.setting.showAll;if(k.setting.showAll&&!k.status.history){k.query.weekDayCN=-1;k.order(k.bangumis,"jp",false)}else{if(!k.status.history){k.query.weekDayCN=f;k.order(k.bangumis,"cn",false)}}b("showAll",k.setting.showAll,{expires:365})};k.archiveHandler=function(i,l){k.readBgm(k.getJsonPath(i,l,k.archive),"jp",false);k.query.weekDayCN=-1;k.status.showAll=true;k.status.history=true};k.topMenuHandler=function(l,o,i,n){for(var m in k.status[o]){k.status[o][m]=false}if(l!==""){k.status[o][l]=i;if(n!==undefined){k.status.shadow=n}else{k.status.shadow=i}}};k.checkSiteList=function(){k.status.selectAll=false;for(e=0,d=k.siteList.length;e<d;e++){if(k.siteList[e].show===false){k.status.selectAll=true;break}}};k.selectAllHandler=function(i){for(e=0,d=k.siteList.length;e<d;e++){k.siteList[e].show=i;b(k.siteList[e].domain,k.siteList[e].show,{expires:365})}k.status.selectAll=!k.status.selectAll};k.order=function(l,o,i){var m="weekDay"+o.toUpperCase(),n="time"+o.toUpperCase();k.status.reversed=!i;k.status.ordered=o;i=i?-1:1;return l.sort(function(q,p){if(q[m]===p[m]){if(q[n]===""){return i*-1}else{if(p[n]===""){return i*1}else{return i*(q[n]-p[n])}}}else{return i*(q[m]-p[m])}})};k.monthToSeason=function(i){switch(true){case (i<4):return 1;case (i<7):return 4;case (i<10):return 7;case (i<=12):return 10;default:throw new Error("failed convrting to season")}};k.getJsonPath=function(n,o,m){for(var l in m){if(m[l].year==n){var i=m[l].months;k.yearRead=m[l].year;k.monthRead=k.monthToSeason(o);for(e=0,d=i.length;e<d;e++){if(k.monthRead===i[e].month&&i[e].json){return i[e].json}}if(k.monthRead===1){return k.getJsonPath(n-1,10,m)}else{return k.getJsonPath(n,o-3,m)}}}return k.getJsonPath(n-1,o,m)};k.readBgm=function(m,i,l){j.get(m).success(function(p,n,q){k.bangumis=k.order(p,i,l);k.query.titleCN="";if(q("Last-Modified")){var o=new Date(q("Last-Modified"));k.status.lastModifieded="数据更新日期: "+o.getFullYear()+"年"+(o.getMonth()+1)+"月"+o.getDate()+"日"}}).error(function(o,n){k.status.error=true;k.status.errorMsg="读取 "+m+" 出错. 错误代码: "+n+". 请点击上方的“提交问题”按钮."})};j.get("json/archive.json").success(function(m,i,n){h=n("Date")?new Date(n("Date")):new Date();f=h.getDay();g=h.getFullYear();c=h.getMonth()+1;k.query.weekDayCN=f;for(var l in m){m[l].show=m[l].year==g?true:false}k.archive=m;k.setting.showAll=b("showAll")||false;if(k.setting.showAll){k.readBgm(k.getJsonPath(g,c,m),"jp",false);k.query.weekDayCN=-1}else{k.readBgm(k.getJsonPath(g,c,m),k.status.ordered,!k.status.reversed)}k.siteList=k.getSiteCookie();k.checkSiteList();k.query.showNew=b("showNew")||false;k.query.nextTime=b("nextTime")||24;k.checkNextTime();k.setting.newTab=b("newTab")||false;k.changeTarget()}).error(function(l,i){k.status.error=true;k.status.errorMsg="读取 archive.json 出错. 错误代码: "+i+". 请点击上方的“提交问题”按钮."})}]).filter("selectAllButton",function(){return function(a){return a?"全选":"全不选"}}).filter("weekday",function(){var a=["周日","周一","周二","周三","周四","周五","周六"];return function(b){return a[b]}}).filter("time",function(){return function(a){return a?a.slice(0,2)+":"+a.slice(2):"(预计)"}}).filter("monthCN",function(){return function(a){switch(+a){case 1:return"一月";case 4:return"四月";case 7:return"七月";case 10:return"十月";default:throw new Error("failed to convert month")}}}).filter("onair",function(){return function(a){switch(getDomain(a)){case"youku":return"优酷";case"sohu":return"搜狐";case"qq":return"腾讯";case"iqiyi":return"爱奇艺";case"letv":return"乐视";case"pptv":return"PPTV";case"tudou":return"土豆";case"bilibili":return"B站";case"acfun":return"A站";case"movie":return"迅雷";case"empty":return"暂无";default:return"未知"}}}).filter("linkFilter",function(){return function(c,a){var b=[];b=c.filter(function(f){for(var e=0,d=a.length;e<d;e++){if(a[e].domain===getDomain(f)){return a[e].show}}return false});if(b.length!==0){return b.sort(function(e,d){e=getDomain(e);d=getDomain(d);if(e<d){return -1}else{if(e>d){return 1}else{return 0}}})}else{return["#"]}}});