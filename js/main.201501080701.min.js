"use strict";$(function(){$("noscript").remove();var al=0,ai=0,ah=0;var ag=0,ae=0,ad=0;var L=0,T=0,s=0,c=0,t=0,ab=0,N=0;var af=0,h=0;var P=null;var R=["周日","周一","周二","周三","周四","周五","周六"];var z=["日曜","月曜","火曜","水曜","木曜","金曜","土曜"];var W=new Date();var f={list:[{name:"A站",domain:"acfun",show:true},{name:"B站",domain:"bilibili",show:true},{name:"搜狐",domain:"sohu",show:true},{name:"优酷",domain:"youku",show:true},{name:"腾讯",domain:"qq",show:true},{name:"爱奇艺",domain:"iqiyi",show:true},{name:"乐视",domain:"letv",show:true},{name:"PPTV",domain:"pptv",show:true},{name:"土豆",domain:"tudou",show:true},{name:"迅雷",domain:"movie",show:true}],turnAll:function(j){var i=[];for(ah=0,ad=this.list.length;ah<ad;ah++){if(this.list[ah].show!==j){this.list[ah].show=j;i.push(this.list[ah].domain)}}return i},show:function(j,i){for(ah=0,ad=this.list.length;ah<ad;ah++){if(this.list[ah].name===j||this.list[ah].domain===j){if(i!==undefined){this.list[ah].show=i}return this.list[ah].show}}return undefined}};var y=$("#bangumiList");var X=$("#shadow");var M=$("#switcher");var ac=$("table th:eq(1) p");var o=$("table th:eq(2) p");var e=$("#search input");var S=$("#topnav");var B=S.find(".menu");var am=B.children("a");var I=B.find(".submenu");var J=$("#hourSelecter");var ao=null,C=null;var Q={reverse:true,ordered:"CN",switchInit:7,switchLog:7,weekDay:-1,nextTime:24,title:"",lastModified:"",showAll:false,history:false,newTab:false,jpTime:false,jpTimeZone:8,jpTitle:false,showNew:false};function F(i){switch(i){case"true":return true;case"false":return false;default:return !!i}}function ap(i,j){switch(j.toLowerCase()){case"cn":return R[i];case"jp":return z[i];default:return R[i]}}function V(i){if(i===-1){return"(未知)"}else{return i?i.slice(0,2)+":"+i.slice(2):"(预计)"}}function Y(i){if(i){var j=i.split("-");return(j[1].length===1?"0"+j[1]:j[1])+"/"+(j[2].length===1?"0"+j[2]:j[2])}else{return""}}function Z(i){switch(true){case (i<4):return 1;case (i<7):return 4;case (i<10):return 7;case (i<=12):return 10;default:throw new Error("failed convrting to season")}}function v(){var j=0;var i=S.find(".sites :checkbox");for(al=0,ag=i.length;al<ag;al++){if(f.show(i.get(al).id)){i.eq(al).attr("checked",true).prev().find("span").addClass("ON");j++}else{i.eq(al).attr("checked",false).prev().find("span").removeClass("ON")}}if(j===i.length){$("#selectAll").text("全不选")}else{$("#selectAll").text("全选")}}function ak(i){var j=/^https{0,}:\/\/\w+\.(\w+)\.\w+/i;if(i!=="#"){return i.match(j)[1].toLowerCase()}else{return""}}function x(k,l,j){af=k;h=Z(l);for(al=0,ag=j.length;al<ag;al++){if(j[al].year===k){var i=j[al].months;for(ai=0,ae=i.length;ai<ae;ai++){if(h===i[ai].month&&i[ai].json){return i[ai].json}}if(h===1){return x(k-1,10,j)}else{return x(k,l-3,j)}}}return x(k-1,l,j)}function E(j,i){j=b(ak(j));i=b(ak(i));if(j.length===i.length){if(j<i){return -1}else{if(j>i){return 1}else{return 0}}}else{return j.length-i.length}}function b(i){switch(i){case"youku":return"优酷";case"sohu":return"搜狐";case"qq":return"腾讯";case"iqiyi":return"爱奇艺";case"letv":return"乐视";case"pptv":return"PPTV";case"tudou":return"土豆";case"bilibili":return"B站";case"acfun":return"A站";case"movie":return"迅雷";default:return"未知"}}function d(i){y.empty();y.append(i);y.find(".links li:last-child").addClass("last");u()}function aa(i){return function(k,j,l){$(this).parents("tr").find("p").removeClass("ordered");$(this).addClass("ordered");if(j!==undefined){r(C,j,i)}else{r(C,!Q.reverse,i)}d(w(C));if(!l){D()}}}function aq(j,l){if(j){var k=j.split("-");var i=+l.slice(0,2);var m=+l.slice(2);if(+k[0]>s||(+k[0]===s&&+k[1]>c)||(+k[0]===s&&+k[1]===c&&+k[2]>t)||(+k[0]===s&&+k[1]===c&&+k[2]===t&&i>ab)||(+k[0]===s&&+k[1]===c&&+k[2]===t&&i===ab&&m>=N)){return true}}return false}function g(){var j="";var i=null;for(al=0,ag=f.list.length;al<ag;al++){j+='<li><label for="'+f.list[al].domain+'">'+f.list[al].name+'<span class="toggle"></span></label><input type="checkbox" name="'+f.list[al].domain+'" id="'+f.list[al].domain+'"></li>'}i=$(j);i.find(":checkbox").change(function(){f.show(this.id,this.checked);v();d(w(C));Q.ordered="CN";M.trigger("click",[Q.switchLog,true]);$.cookie(this.id,this.checked,{expires:365})});S.find(".sites").prepend(i)}function r(m,k,ar){var j="",n="";var i=(k?-1:1);var l=0,at=0;Q.reverse=k;Q.ordered=ar;if(ar){j="weekDay"+ar.toUpperCase();n="time"+ar.toUpperCase()}else{j="weekDayCN";n="timeCN"}m.sort(function(av,au){if(av[j]===au[j]){l=(av[n]===""?-1:+av[n]);at=(au[n]===""?-1:+au[n]);if(l===at){return i*(av.officalSite-au.officalSite)}else{return i*(l-at)}}else{return i*(av[j]-au[j])}})}function w(j){var i="",k="";for(al=0,ag=j.length;al<ag;al++){i+='<tr><td><a href="'+j[al].officalSite+'" title="'+(Q.jpTitle?j[al].titleCN:j[al].titleJP)+(j[al].newBgm?'" class="new">':'">')+(Q.jpTitle?j[al].titleJP:j[al].titleCN)+"</a></td><td>"+(j[al].comment?'<div class="comment"><div class="tooltip">'+j[al].comment+"</div></div>":"")+"</td><td>";if(aq((j[al].showDate||""),j[al].timeJP)){i+='<abbr class="showDate" title="放送日期: '+(j[al].showDate||"")+'">'+Y(j[al].showDate)}else{i+='<abbr class="weekDay" title="放送日期: '+(j[al].showDate||"")+'">'+ap(j[al].weekDayJP,(Q.jpTime?"jp":"cn"))}i+='</abbr><span class="time">'+V(j[al].timeJP)+'</span></td><td><span class="weekDay">'+ap(j[al].weekDayCN,"cn")+'</span><span class="time">'+V(j[al].timeCN)+"</span></td>";if(j[al].onAirSite.length){k="";j[al].onAirSite.sort(E);i+='<td><ul class="links">';for(ai=0,ae=j[al].onAirSite.length;ai<ae;ai++){if(f.show(ak(j[al].onAirSite[ai]))){if(ai===ae-1){k+="<li>"}else{k+="<li>"}k+='<a href="'+j[al].onAirSite[ai]+'" target="_self">'+b(ak(j[al].onAirSite[ai]))+"</a></li>"}}if(k===""){k+='<li class="empty">过滤</li>'}i+=k+"</ul></td></tr>"}else{i+='<td><ul class="links"><li class="empty">暂无</li></ul></td></tr>'}}return i}function H(l){var k="";var j=null;for(al=0,ag=l.length;al<ag;al++){var i=l[al].months;k+='<li><a href="#">'+l[al].year+'年</a><ul class="submenu month">';for(ai=0,ae=i.length;ai<ae;ai++){k+='<li><a href="#" data-json="'+i[ai].json+'">'+i[ai].month+"月</a></li>"}k+="</ul></li>"}j=$(k);j.each(function(){$(this).hover(function(){$(this).find("ul").show()},function(){$(this).find("ul").hide()}).find("ul").hide()});j.find("ul a").click(function(){var m=$(this).data("json");Q.history=true;q(m);af=+("20"+m.match(/(\d{2})(\d{2})/)[1]);h=+(m.match(/(\d{2})(\d{2})/)[2]);$(this).parents(".submenu").hide();return false});S.find("li ul.year").append(j)}function D(){var j=y.find("tr");var i=0;j.detach();for(al=0,ag=j.length;al<ag;al++){if(Q.showNew&&j.eq(al).find(".new").length){j.eq(al).find(".new").addClass("hideMark")}else{j.eq(al).find(".new").removeClass("hideMark")}if(A(j.eq(al))){j.eq(al).show();i++}else{j.eq(al).hide()}}j.appendTo(y);if(i===0){$('<tr><td colspan="5">无结果</td></tr>').appendTo(y)}}function u(){y.find(".comment").click(function(){var i=$(this).find("div");if(i.css("display")==="block"){i.fadeOut(200)}else{if($(this).position().top<=i.innerHeight()*2){i.addClass("opposite");i.fadeIn(200)}else{i.fadeIn(200)}}}).hover(function(){var i=$(this).find("div");if($(this).position().top<=i.innerHeight()*2){i.addClass("opposite")}i.fadeIn(200)},function(){$(this).find("div").fadeOut(200)})}function O(i){if(i){y.find("a").attr("target",i)}else{y.find("a").attr("target","_self")}}function a(){J.find("span").removeClass("disable");if(Q.nextTime===24){J.find(".right").addClass("disable")}else{if(Q.nextTime===20){J.find(".left").addClass("disable")}}J.find("p").text(Q.nextTime+"点")}function A(m){var l=false;var k=m.find("td:eq(3) .weekDay").text();var i=+(m.find("td:eq(3) .time").text().slice(0,2));if(!i){i=0}if(Q.weekDay===-1){l=true}else{if((k===R[Q.weekDay]&&i<Q.nextTime)||(k===R[(Q.weekDay===0?6:Q.weekDay-1)]&&i>=Q.nextTime)){l=true}}if(Q.showNew&&!(m.find("td:eq(0) a").is(".new"))){l=false}if(Q.title){var j=new RegExp("\\"+Q.title,"i");var n=m.find("td:eq(0) a");if(!j.test(n.text())&&!j.test(n.attr("title"))){l=false}}return l}function p(j){var k=M.find("li:eq("+j+")");var i=k.text();k.text("今天");k.hover(function(){$(this).text(i)},function(){$(this).text("今天")})}function U(){if($.cookie("showNew")!==undefined){Q.showNew=$.cookie("showNew",F)}if(Q.showNew){S.find("#showNew").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("showAll")!==undefined){Q.showAll=$.cookie("showAll",F)}if(Q.showAll){S.find("#showAll").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("newTab")!==undefined){Q.newTab=$.cookie("newTab",F)}if(Q.newTab){S.find("#newTab").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("jpTime")!==undefined){Q.jpTime=$.cookie("jpTime",F)}if(Q.jpTime){S.find("#jpTime").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("jpTitle")!==undefined){Q.jpTitle=$.cookie("jpTitle",F)}if(Q.jpTitle){S.find("#jpTitle").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("nextTime")!==undefined){Q.nextTime=$.cookie("nextTime",Number)}a();for(al=0,ag=f.list.length;al<ag;al++){if($.cookie(f.list[al].domain)!==undefined){f.list[al].show=$.cookie(f.list[al].domain,F)}}}function an(){var i=document.cookie.match(/[^ =;]+(?=\=)/g);if(i){for(al=0,ag=i.length;al<ag;al++){$.removeCookie(i[al])}}location.reload(true)}function K(i){var k=""+i.getFullYear();var l=""+(i.getMonth()+1);var j=""+i.getDate();return k+"-"+(l.length===1?"0"+l:l)+"-"+(j.length===1?"0"+j:j)}function G(ar,j){var n=j-Q[ar.toLowerCase()+"TimeZone"];var m="time"+ar.toUpperCase();var at="weekDay"+ar.toUpperCase();var l,i,k;for(al=0,ag=C.length;al<ag;al++){l=+C[al][m].slice(0,2);i=+C[al][at];k=new Date(C[al].showDate);l=l+n;if(l<0){l+=24;i--;k.setDate(k.getDate()-1)}else{if(l>=24){l-=24;i++;k.setDate(k.getDate()+1)}}if(l<10){l="0"+l}if(i<0){i+=7}else{if(i>6){i-=7}}C[al][m]=l+C[al][m].slice(2);C[al][at]=i+"";C[al].showDate=K(k)}Q[ar.toLowerCase()+"TimeZone"]=j}function q(i){X.show();$.ajax({url:i,data:"t="+W.getTime(),success:function(l,k,m){C=l;U();if(Q.history){Q.jpTimeZone=8}if(Q.jpTime){G("jp",9)}if(Q.history||Q.showAll){M.trigger("click",[7,true,true])}else{M.trigger("click",[Q.switchInit,true,true])}D();v();if(Q.newTab){O("_blank")}if(m.getResponseHeader("Last-Modified")){var j=new Date(m.getResponseHeader("Last-Modified"));Q.lastModified="数据更新日期: "+j.getFullYear()+"年"+(j.getMonth()+1)+"月"+j.getDate()+"日"}$("#header h1").text(af+"年"+h+"月番组");$("#header .total").text("当季共有"+l.length+"部番组");$("#header .lastModified").text(Q.lastModified);aj();X.fadeOut(200)},error:function(l,k,j){y.empty();y.append('<tr><td colspan="5">读取 '+i+" 出错，错误代码："+l.status+" "+j+"</td></tr>");X.fadeOut(200)}})}$.ajax({url:"json/archive.json",data:"t="+W.getFullYear()+W.getMonth(),success:function(j,i,k){L=(k.getResponseHeader("Date")?new Date(k.getResponseHeader("Date")):new Date());s=L.getFullYear();t=L.getDate();c=L.getMonth()+1;T=L.getDay();ab=L.getHours();N=L.getMinutes();Q.switchInit=(T===0?6:T-1);p(Q.switchInit);ao=j;q(x(s,c,j));H(j)},error:function(k,j,i){y.empty();y.append('<tr><td colspan="5">读取 json/archive.json 出错，错误代码：'+k.status+" "+i+"</td></tr>");X.fadeOut(200)}});g();M.click(function(l,k,m,j){var i=$(l.target);if(l.target!==this||m){M.find("li").removeClass("selected");if(k!==undefined){M.find("li:eq("+k+")").addClass("selected")}else{k=i.index();i.addClass("selected")}Q.switchLog=k;if(k===6){Q.weekDay=0}else{if(k===7){Q.weekDay=-1}else{Q.weekDay=k+1}}if(k===7&&(Q.ordered!=="JP"||Q.reverse!==false)){ac.trigger("click",[false,true])}else{if(Q.ordered!=="CN"||Q.reverse!==false){o.trigger("click",[false,true])}}if(!j){D()}}});o.click(aa("CN"));ac.click(aa("JP"));am.click(function(i){var j=$(this).next();if(j.css("display")==="block"){j.fadeOut(200);X.fadeOut(200)}else{I.hide();j.fadeIn(200);X.fadeIn(200)}return false});e.keyup(function(i){if(i.target.value.length===1){M.trigger("click",[7,true,true])}$(this).next().show();Q.title=$(this).val();D();if(i.keyCode===27){$(this).blur().val("");Q.title="";if(Q.showAll||Q.history){M.trigger("click",[7,true])}else{M.trigger("click",[Q.switchInit,true])}$(this).next().hide()}else{if(i.keyCode===8&&i.target.value.length<=0){if(Q.showAll||Q.history){M.trigger("click",[7,true])}else{M.trigger("click",[Q.switchInit,true])}$(this).next().hide()}}}).on("paste",function(i){M.trigger("click",[7,true,true])}).next().hide().click(function(){e.blur().val("");Q.title="";M.trigger("click",[Q.switchInit,true]);$(this).hide()});$("#showNew").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}Q.showNew=this.checked;$.cookie("showNew",this.checked,{expires:365});D()});$("#showAll").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}Q.showAll=this.checked;if(this.checked){M.trigger("click",[7,true])}else{M.trigger("click",[Q.switchInit,true])}$.cookie("showAll",this.checked,{expires:365});D()});$("#newTab").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}Q.newTab=this.checked;$.cookie("newTab",this.checked,{expires:365});O((Q.newTab?"_blank":"_self"))});$("#jpTime").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}Q.jpTime=this.checked;$.cookie("jpTime",this.checked,{expires:365});if(Q.jpTime){G("jp",9)}else{G("jp",8)}d(w(C));D()});$("#jpTitle").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}Q.jpTitle=this.checked;$.cookie("jpTitle",this.checked,{expires:365});d(w(C));D()});J.find("span").click(function(i){if(i.target.className==="right"&&Q.nextTime<24){Q.nextTime++;D()}else{if(i.target.className==="left"&&Q.nextTime>20){Q.nextTime--;D()}}a();$.cookie("nextTime",Q.nextTime,{expires:365})});$("#reset").click(an);$("#selectAll").click(function(){var i=null;if($(this).text()==="全选"){i=f.turnAll(true)}else{if($(this).text()==="全不选"){i=f.turnAll(false)}}d(w(C));M.trigger("click",[Q.switchLog,true]);v();for(al=0,ag=i.length;al<ag;al++){$.cookie(i[al],f.show(i[al]),{expires:365})}});X.click(function(){$(this).fadeOut(200);I.hide()});S.find(".share a").click(function(){window.open(this.href,"","height=420, width=550, scrollbars=yes");return false});function aj(){$("abbr").click(function(){var i=$(this).children(".tip");if(i.length===0){$("<div>"+this.title+"</div>").addClass("tip").click(function(){$(this).fadeOut(300);return false}).appendTo($(this)).fadeIn(300)}else{i.fadeIn(300)}return false}).mouseleave(function(){$(this).children(".tip").fadeOut(300)})}});