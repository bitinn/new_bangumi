"use strict";$(function(){$("noscript").remove();var ah=0,af=0,ae=0;var ad=0,ab=0,aa=0;var L=0,S=0,s=0,c=0,t=0;var ac=0,h=0;var O=null;var Q=["周日","周一","周二","周三","周四","周五","周六"];var z=["日曜","月曜","火曜","水曜","木曜","金曜","土曜"];var f={list:[{name:"A站",domain:"acfun",show:true},{name:"B站",domain:"bilibili",show:true},{name:"搜狐",domain:"sohu",show:true},{name:"优酷",domain:"youku",show:true},{name:"腾讯",domain:"qq",show:true},{name:"爱奇艺",domain:"iqiyi",show:true},{name:"乐视",domain:"letv",show:true},{name:"PPTV",domain:"pptv",show:true},{name:"土豆",domain:"tudou",show:true},{name:"迅雷",domain:"movie",show:true}],turnAll:function(j){var i=[];for(ae=0,aa=this.list.length;ae<aa;ae++){if(this.list[ae].show!==j){this.list[ae].show=j;i.push(this.list[ae].domain)}}return i},show:function(j,i){for(ae=0,aa=this.list.length;ae<aa;ae++){if(this.list[ae].name===j||this.list[ae].domain===j){if(i!==undefined){this.list[ae].show=i}return this.list[ae].show}}return undefined}};var y=$("#bangumiList");var V=$("#shadow");var M=$("#switcher");var Z=$("table th:eq(1) p");var o=$("table th:eq(2) p");var e=$("#search input");var R=$("#topnav");var B=R.find(".menu");var ai=B.children("a");var I=B.find(".submenu");var J=$("#hourSelecter");var ak=null,C=null;var P={reverse:true,ordered:"CN",switchInit:7,switchLog:7,weekDay:-1,nextTime:24,title:"",lastModified:"",showAll:false,history:false,newTab:false,jpTime:false,jpTimeZone:8,jpTitle:false,showNew:false};function F(i){switch(i){case"true":return true;case"false":return false;default:return !!i}}function al(i,j){switch(j.toLowerCase()){case"cn":return Q[i];case"jp":return z[i];default:return Q[i]}}function U(i){if(i===-1){return"(未知)"}else{return i?i.slice(0,2)+":"+i.slice(2):"(预计)"}}function W(i){if(i){var j=i.split("-");return(j[1].length===1?"0"+j[1]:j[1])+"/"+(j[2].length===1?"0"+j[2]:j[2])}else{return""}}function X(i){switch(true){case (i<4):return 1;case (i<7):return 4;case (i<10):return 7;case (i<=12):return 10;default:throw new Error("failed convrting to season")}}function v(){var j=0;var i=R.find(".sites :checkbox");for(ah=0,ad=i.length;ah<ad;ah++){if(f.show(i.get(ah).id)){i.eq(ah).attr("checked",true).prev().find("span").addClass("ON");j++}else{i.eq(ah).attr("checked",false).prev().find("span").removeClass("ON")}}if(j===i.length){$("#selectAll").text("全不选")}else{$("#selectAll").text("全选")}}function ag(i){var j=/^https{0,}:\/\/\w+\.(\w+)\.\w+/i;if(i!=="#"){return i.match(j)[1].toLowerCase()}else{return""}}function x(k,l,j){ac=k;h=X(l);for(ah=0,ad=j.length;ah<ad;ah++){if(j[ah].year===k){var i=j[ah].months;for(af=0,ab=i.length;af<ab;af++){if(h===i[af].month&&i[af].json){return i[af].json}}if(h===1){return x(k-1,10,j)}else{return x(k,l-3,j)}}}return x(k-1,l,j)}function E(j,i){j=b(ag(j));i=b(ag(i));if(j.length===i.length){if(j<i){return -1}else{if(j>i){return 1}else{return 0}}}else{return j.length-i.length}}function b(i){switch(i){case"youku":return"优酷";case"sohu":return"搜狐";case"qq":return"腾讯";case"iqiyi":return"爱奇艺";case"letv":return"乐视";case"pptv":return"PPTV";case"tudou":return"土豆";case"bilibili":return"B站";case"acfun":return"A站";case"movie":return"迅雷";default:return"未知"}}function d(i){y.empty();y.append(i);y.find(".links li:last-child").addClass("last");u()}function Y(i){return function(k,j,l){$(this).parents("tr").find("p").removeClass("ordered");$(this).addClass("ordered");if(j!==undefined){r(C,j,i)}else{r(C,!P.reverse,i)}d(w(C));if(!l){D()}}}function am(i){if(i){var j=i.split("-");if(+j[0]>s||(+j[0]===s&&+j[1]>c)||(+j[0]===s&&+j[1]===c&&+j[2]>=t)){return true}}return false}function g(){var j="";var i=null;for(ah=0,ad=f.list.length;ah<ad;ah++){j+='<li><label for="'+f.list[ah].domain+'">'+f.list[ah].name+'<span class="toggle"></span></label><input type="checkbox" name="'+f.list[ah].domain+'" id="'+f.list[ah].domain+'"></li>'}i=$(j);i.find(":checkbox").change(function(){f.show(this.id,this.checked);v();d(w(C));P.ordered="CN";M.trigger("click",[P.switchLog,true]);$.cookie(this.id,this.checked,{expires:365})});R.find(".sites").prepend(i)}function r(m,k,an){var j="",n="";var i=(k?-1:1);var l=0,ao=0;P.reverse=k;P.ordered=an;if(an){j="weekDay"+an.toUpperCase();n="time"+an.toUpperCase()}else{j="weekDayCN";n="timeCN"}m.sort(function(aq,ap){if(aq[j]===ap[j]){l=(aq[n]===""?-1:+aq[n]);ao=(ap[n]===""?-1:+ap[n]);if(l===ao){return i*(aq.officalSite-ap.officalSite)}else{return i*(l-ao)}}else{return i*(aq[j]-ap[j])}})}function w(j){var i="",k="";for(ah=0,ad=j.length;ah<ad;ah++){i+='<tr><td><a href="'+j[ah].officalSite+'" title="'+(P.jpTitle?j[ah].titleCN:j[ah].titleJP)+(j[ah].newBgm?'" class="new">':'">')+(P.jpTitle?j[ah].titleJP:j[ah].titleCN)+"</a></td><td>"+(j[ah].comment?'<div class="comment"><div class="tooltip">'+j[ah].comment+"</div></div>":"")+'</td><td><abbr class="weekDay" title="放送日期: '+(j[ah].showDate||"")+'">';if(am(j[ah].showDate||"")){i+=W(j[ah].showDate)}else{i+=al(j[ah].weekDayJP,(P.jpTime?"jp":"cn"))}i+='</abbr><span class="time">'+U(j[ah].timeJP)+'</span></td><td><span class="weekDay">'+al(j[ah].weekDayCN,"cn")+'</span><span class="time">'+U(j[ah].timeCN)+"</span></td>";if(j[ah].onAirSite.length){k="";j[ah].onAirSite.sort(E);i+='<td><ul class="links">';for(af=0,ab=j[ah].onAirSite.length;af<ab;af++){if(f.show(ag(j[ah].onAirSite[af]))){if(af===ab-1){k+="<li>"}else{k+="<li>"}k+='<a href="'+j[ah].onAirSite[af]+'" target="_self">'+b(ag(j[ah].onAirSite[af]))+"</a></li>"}}if(k===""){k+='<li class="empty">过滤</li>'}i+=k+"</ul></td></tr>"}else{i+='<td><ul class="links"><li class="empty">暂无</li></ul></td></tr>'}}return i}function H(l){var k="";var j=null;for(ah=0,ad=l.length;ah<ad;ah++){var i=l[ah].months;k+='<li><a href="#">'+l[ah].year+'年</a><ul class="submenu month">';for(af=0,ab=i.length;af<ab;af++){k+='<li><a href="#" data-json="'+i[af].json+'">'+i[af].month+"月</a></li>"}k+="</ul></li>"}j=$(k);j.each(function(){$(this).hover(function(){$(this).find("ul").show()},function(){$(this).find("ul").hide()}).find("ul").hide()});j.find("ul a").click(function(){var m=$(this).data("json");P.history=true;q(m);ac=+("20"+m.match(/(\d{2})(\d{2})/)[1]);h=+(m.match(/(\d{2})(\d{2})/)[2]);$(this).parents(".submenu").hide();return false});R.find("li ul.year").append(j)}function D(){var j=y.find("tr");var i=0;j.detach();for(ah=0,ad=j.length;ah<ad;ah++){if(P.showNew&&j.eq(ah).find(".new").length){j.eq(ah).find(".new").addClass("hideMark")}else{j.eq(ah).find(".new").removeClass("hideMark")}if(A(j.eq(ah))){j.eq(ah).show();i++}else{j.eq(ah).hide()}}j.appendTo(y);if(i===0){$('<tr><td colspan="5">无结果</td></tr>').appendTo(y)}}function u(){y.find(".comment").click(function(){var i=$(this).find("div");if(i.css("display")==="block"){i.fadeOut(200)}else{if($(this).position().top<=i.innerHeight()*2){i.addClass("opposite");i.fadeIn(200)}else{i.fadeIn(200)}}}).hover(function(){var i=$(this).find("div");if($(this).position().top<=i.innerHeight()*2){i.addClass("opposite")}i.fadeIn(200)},function(){$(this).find("div").fadeOut(200)})}function N(i){if(i){y.find("a").attr("target",i)}else{y.find("a").attr("target","_self")}}function a(){J.find("span").removeClass("disable");if(P.nextTime===24){J.find(".right").addClass("disable")}else{if(P.nextTime===20){J.find(".left").addClass("disable")}}J.find("p").text(P.nextTime+"点")}function A(m){var l=false;var k=m.find("td:eq(3) .weekDay").text();var i=+(m.find("td:eq(3) .time").text().slice(0,2));if(!i){i=0}if(P.weekDay===-1){l=true}else{if((k===Q[P.weekDay]&&i<P.nextTime)||(k===Q[(P.weekDay===0?6:P.weekDay-1)]&&i>=P.nextTime)){l=true}}if(P.showNew&&!(m.find("td:eq(0) a").is(".new"))){l=false}if(P.title){var j=new RegExp("\\"+P.title,"i");var n=m.find("td:eq(0) a");if(!j.test(n.text())&&!j.test(n.attr("title"))){l=false}}return l}function p(j){var k=M.find("li:eq("+j+")");var i=k.text();k.text("今天");k.hover(function(){$(this).text(i)},function(){$(this).text("今天")})}function T(){if($.cookie("showNew")!==undefined){P.showNew=$.cookie("showNew",F)}if(P.showNew){R.find("#showNew").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("showAll")!==undefined){P.showAll=$.cookie("showAll",F)}if(P.showAll){R.find("#showAll").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("newTab")!==undefined){P.newTab=$.cookie("newTab",F)}if(P.newTab){R.find("#newTab").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("jpTime")!==undefined){P.jpTime=$.cookie("jpTime",F)}if(P.jpTime){R.find("#jpTime").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("jpTitle")!==undefined){P.jpTitle=$.cookie("jpTitle",F)}if(P.jpTitle){R.find("#jpTitle").attr("checked",true).prev().find("span").addClass("ON")}if($.cookie("nextTime")!==undefined){P.nextTime=$.cookie("nextTime",Number)}a();for(ah=0,ad=f.list.length;ah<ad;ah++){if($.cookie(f.list[ah].domain)!==undefined){f.list[ah].show=$.cookie(f.list[ah].domain,F)}}}function aj(){var i=document.cookie.match(/[^ =;]+(?=\=)/g);if(i){for(ah=0,ad=i.length;ah<ad;ah++){$.removeCookie(i[ah])}}location.reload(true)}function K(i){var k=""+i.getFullYear();var l=""+(i.getMonth()+1);var j=""+i.getDate();return k+"-"+(l.length===1?"0"+l:l)+"-"+(j.length===1?"0"+j:j)}function G(an,j){var n=j-P[an.toLowerCase()+"TimeZone"];var m="time"+an.toUpperCase();var ao="weekDay"+an.toUpperCase();var l,i,k;for(ah=0,ad=C.length;ah<ad;ah++){l=+C[ah][m].slice(0,2);i=+C[ah][ao];k=new Date(C[ah].showDate);l=l+n;if(l<0){l+=24;i--;k.setDate(k.getDate()-1)}else{if(l>=24){l-=24;i++;k.setDate(k.getDate()+1)}}if(l<10){l="0"+l}if(i<0){i+=7}else{if(i>6){i-=7}}C[ah][m]=l+C[ah][m].slice(2);C[ah][ao]=i+"";C[ah].showDate=K(k)}P[an.toLowerCase()+"TimeZone"]=j}function q(i){V.show();$.ajax({url:i,success:function(l,k,m){C=l;T();if(P.history){P.jpTimeZone=8}if(P.jpTime){G("jp",9)}if(P.history||P.showAll){M.trigger("click",[7,true,true])}else{M.trigger("click",[P.switchInit,true,true])}D();v();if(P.newTab){N("_blank")}if(m.getResponseHeader("Last-Modified")){var j=new Date(m.getResponseHeader("Last-Modified"));P.lastModified="数据更新日期: "+j.getFullYear()+"年"+(j.getMonth()+1)+"月"+j.getDate()+"日"}$("#header h1").text(ac+"年"+h+"月番组");$("#header .total").text("当季共有"+l.length+"部番组");$("#header .lastModified").text(P.lastModified);V.fadeOut(200)},error:function(l,k,j){y.empty();y.append('<tr><td colspan="5">读取 '+i+" 出错，错误代码："+l.status+" "+j+"</td></tr>");V.fadeOut(200)}})}$.ajax({url:"json/archive.json",success:function(j,i,k){L=(k.getResponseHeader("Date")?new Date(k.getResponseHeader("Date")):new Date());s=L.getFullYear();t=L.getDate();c=L.getMonth()+1;S=L.getDay();P.switchInit=(S===0?6:S-1);p(P.switchInit);ak=j;q(x(s,c,j));H(j)},error:function(k,j,i){y.empty();y.append('<tr><td colspan="5">读取 json/archive.json 出错，错误代码：'+k.status+" "+i+"</td></tr>");V.fadeOut(200)}});g();M.click(function(l,k,m,j){var i=$(l.target);if(l.target!==this||m){M.find("li").removeClass("selected");if(k!==undefined){M.find("li:eq("+k+")").addClass("selected")}else{k=i.index();i.addClass("selected")}P.switchLog=k;if(k===6){P.weekDay=0}else{if(k===7){P.weekDay=-1}else{P.weekDay=k+1}}if(k===7&&(P.ordered!=="JP"||P.reverse!==false)){Z.trigger("click",[false,true])}else{if(P.ordered!=="CN"||P.reverse!==false){o.trigger("click",[false,true])}}if(!j){D()}}});o.click(Y("CN"));Z.click(Y("JP"));ai.click(function(i){var j=$(this).next();if(j.css("display")==="block"){j.fadeOut(200);V.fadeOut(200)}else{I.hide();j.fadeIn(200);V.fadeIn(200)}return false});e.keyup(function(i){if(i.target.value.length===1){M.trigger("click",[7,true,true])}$(this).next().show();P.title=$(this).val();D();if(i.keyCode===27){$(this).blur().val("");P.title="";if(P.showAll||P.history){M.trigger("click",[7,true])}else{M.trigger("click",[P.switchInit,true])}$(this).next().hide()}else{if(i.keyCode===8&&i.target.value.length<=0){if(P.showAll||P.history){M.trigger("click",[7,true])}else{M.trigger("click",[P.switchInit,true])}$(this).next().hide()}}}).next().hide().click(function(){e.blur().val("");P.title="";M.trigger("click",[P.switchInit,true]);$(this).hide()});$("#showNew").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}P.showNew=this.checked;$.cookie("showNew",this.checked,{expires:365});D()});$("#showAll").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}P.showAll=this.checked;if(this.checked){M.trigger("click",[7,true])}else{M.trigger("click",[P.switchInit,true])}$.cookie("showAll",this.checked,{expires:365});D()});$("#newTab").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}P.newTab=this.checked;$.cookie("newTab",this.checked,{expires:365});N((P.newTab?"_blank":"_self"))});$("#jpTime").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}P.jpTime=this.checked;$.cookie("jpTime",this.checked,{expires:365});if(P.jpTime){G("jp",9)}else{G("jp",8)}d(w(C));D()});$("#jpTitle").change(function(){if(this.checked){$(this).prev().find("span").addClass("ON")}else{$(this).prev().find("span").removeClass("ON")}P.jpTitle=this.checked;$.cookie("jpTitle",this.checked,{expires:365});d(w(C));D()});J.find("span").click(function(i){if(i.target.className==="right"&&P.nextTime<24){P.nextTime++;D()}else{if(i.target.className==="left"&&P.nextTime>20){P.nextTime--;D()}}a();$.cookie("nextTime",P.nextTime,{expires:365})});$("#reset").click(aj);$("#selectAll").click(function(){var i=null;if($(this).text()==="全选"){i=f.turnAll(true)}else{if($(this).text()==="全不选"){i=f.turnAll(false)}}d(w(C));M.trigger("click",[P.switchLog,true]);v();for(ah=0,ad=i.length;ah<ad;ah++){$.cookie(i[ah],f.show(i[ah]),{expires:365})}});V.click(function(){$(this).fadeOut(200);I.hide()});R.find(".share a").click(function(){window.open(this.href,"","height=420, width=550, scrollbars=yes");return false})});